# 脚手架命令注册和执行

## 收获

- 如何设计高性能脚手架

  - 缓存
  - 多进程

- node多进程

node.js是没有多线程概念的，只能利用多进程利用CPU多核，提升性能

- JS面向对象

面向对象可以实现一种可扩展的架构，将具有共性的部分封装，是实现可扩展，高复用性的一种重要手段，可以通过继承不断扩展

## 内容

1，高性能脚手架架构设计方法

2，封装通用的Package和Command类

3，基于缓存+Node多进程实现动态命令加载和执行

4，业务逻辑和脚手架框架解耦

- 不管业务逻辑如何扩展，脚手架的底层框架基本不需要改动，这也是架构设计的思想

## 要点

1，面向对象可以实现一种可扩展性的架构，原理：将具有共性的代码抽离出来，封装起来

- 通过继承不断扩展

## 脚手架的痛点

1，init命令可能都各不相同，需要实现init命令动态化

### 动态加载initCommand

1，用户主目录需要预先检查，在initCommand阶段，需要init包下载到本地，需要用到用户主目录

2，node.js用参数的形式执行

```sh
node -e "require('../cli/bin/index.js')"
```

3，不依赖当前脚手架去执行新的命令，通过命令的一个地址就可以去执行

4，环境变量可以脱离执行环境，可以在全局共享某些值

- 环境变量是整个**操作系统**级别的变量
- 使用program.on('option:*')做属性监听时，会在执行业务逻辑之前执行

### @fujia/cli-package

1，获取入口文件路径 - pkg-dir

- 读取package.json:使用require
- 找到main/lib字段
- 路径兼容(macOS/window)

**可以通过环境变量实现业务逻辑解耦**

2，将模块独立出来的好处是便于复用

## node多进程 -- child_process源码分析

> 深入node源码，理解spawn/exec/execFile/fork的本质区别