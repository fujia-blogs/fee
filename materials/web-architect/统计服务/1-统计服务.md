# 统计服务

> event analytics server 事件统计服务 - 实现分渠道统计

1，自定义事件统计，线上产品必备的统计功能，包括：收集日志，分析日志，open api 功能

2，收集第三方统计服务，有哪些第三方统计服务？

- 友盟，web 统计不支持自定义事件和 open api
- 百度统计，需要付费，每年 3w 左右
- 阿里 arms，不支持自定义事件的 open api 获取
- 腾讯移动分析，支持自定义事件上报

3，自研统计服务 - Investigator

## 需求分析

1，分渠道统计

## 技术方案

> 需求指导设计，设计指导开发

1，产出《技术方案设计》文档

### 第三方服务

1，切记：专业性较强的业务，一定要优先考虑第三方服务，特别是业务早期，要快速优先实现功能，验证需求的可行性。强烈不建议，任何需求都去自研。**一定要提前做技术调研，一定要提前做技术调研，一定要提前做技术调研！！！**

### 流程图

### 实现方案

#### nginx 收集日志

1，Nginx 提供一个 web server，返回一个小图片，如：http://localhost:8888/event.png

- 简单，无论是 server 还是 h5
- 没有跨域
- 小图片，小流量

2，访问请求，Nginx 会自动记录 access_log

3，Nginx 对前端来说是一个非常有用的工具，**每个前端都应该了解 Nginx**，可以不用专精

## 日志收集、拆分和定期清理

1，定时拆分 access_log，根据流量大小，可以按天、小时、分钟来拆分

2，定时分析计算日志结果，如：每天凌晨 4:00，分析昨天的日志

3，定时清理历史日志文件

### 技术

1，Linux 自带的 crontab 定时任务

2，npm 插件 node-cron 和 node-schedule

## 分析日志、得到统计服务

## 提供 Open api 服务

1，用 nodejs 服务即可

## 安全与运维

### 运维

1，服务器要考虑硬盘空间

2，运维监控时，考虑硬盘监控 - ali-node 有这个功能

3，及时清理历史日志

### 安全

1，open api 设置 CORS 只允许特定的 host 访问

2，日志收集，可能会恶意注入数据，可以使用阿里云防火墙

## 要点

1，比较专业的服务，尽量使用靠谱的第三方，自研是下策，如果市场无法满足的话
