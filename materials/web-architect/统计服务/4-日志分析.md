# 日志分析

1. 分析日志，得到统计结果，写入数据库

## 产出文档

1. 技术方案设计文档

2. 定时任务：

- 日志分析
- 计算统计结果
- 写入数据库

## 注意

1. URL 设计和存储数据结构设计

2. 使用 readline(即，stream)，考虑日志文件肯能很大，一次性打开可能占据很大内存。

3. 扩展性和通用性。

## 技术方案设计

1. 做一个通用的自定义事件统计服务，不仅仅是作品分渠道统计。

- 需求是什么
- 需要收集哪些信息
- 需要输出哪些信息
- 如何做到？

### 需求是什么

### 需要收集哪些信息

1. 一个产品为例：https://cue.fujia.site/event.png?a=a_01&p=a_id&b=b_01&e=e_01

- a - application，即应用
- p - page，即页面由多级 tab 栏目加 ID 组成
- b - block，即页面中的一个块
- e - element，即页面中的一个具体元素

2. 如何收集？

**实现一个通用的自定义事件统计服务。**

按照通用的参数设计如下：

- category
- action
- label
- value

### 如何计算？

1. 离线计算，每天凌晨定时分析昨天的日志，计算出昨天的统计结果，要晚于拆分日志(00:00)，拆分完再计算。

- 根据日志文件名，得到昨天的日志
- 逐行读取日志文件，累加统计结果
- 读取完毕，输出统计结果

### 需要输出哪些信息

1. 输入信息：

- 开始时间
- 结束时间
- 各个参数

2. 输出结果：

- 日期范围内的所有统计数据

### 存入数据库

1. MongoDB：

```js
mongoose.Schema({
  key: String,
  data: {
    pv: Number,
  },
  date: Date,
});
```

2. readline

**操作大文件，一定要用 stream**，否则可能导致内存爆满。

- readline 是 stream 的一个具体场景，即逐行读取。

### 如何做到？

## 日志分析 - 技术方案

### 需求分析

1. 通用性

2. 扩展性

### 数据收集

#### 收集哪些数据？

#### URL 参数设计

### 计算结果

#### 如何计算？

1. 使用 readline 的方式

### 数据结构

### 数据获取

### 数据库
